<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BIO-QUEST â€” The Living Universe Adventure</title>
  <style>
    /* CSS tetap sama seperti sebelumnya */
    /* ... (semua CSS tetap) ... */
  </style>
</head>
<body class="slide-in">
  <!-- Audio element untuk backsound -->
  <audio id="bgMusic" loop>
    <source src="https://assets.mixkit.co/music/preview/mixkit-tech-house-vibes-130.mp3" type="audio/mpeg">
    Browser Anda tidak mendukung elemen audio.
  </audio>
  
  <div class="app">
    <div class="shell">
      <!-- HTML struktur tetap sama -->
      <!-- ... (semua HTML struktur tetap) ... -->
    </div>
  </div>

  <script>
    // ---------- Data: 30+ Questions ----------
    const QUESTIONS = {
      // Data pertanyaan tetap sama
      // ... (data QUESTIONS tetap) ...
    };

    // ---------- State ----------
    let state = {
      xp: 0,
      coins: 0,
      lives: 3,
      progress: 0,
      currentZone: null,
      qIndex: 0,
      zoneQuestions: [],
      zoneLevel: 1
    };

    // ---------- DOM ----------
    // Variabel DOM tetap sama
    // ... (variabel DOM tetap) ...

    // Game variables
    let gameIntervals = [];
    let musicStarted = false;

    // ---------- Background Music ----------
    // Fungsi audio tetap sama
    // ... (fungsi audio tetap) ...

    // ---------- Simple audio via WebAudio (synth) ----------
    // Fungsi audio tetap sama
    // ... (fungsi audio tetap) ...

    // ---------- Interaction ----------
    // Event listeners tetap sama
    // ... (event listeners tetap) ...

    // Fungsi-fungsi utama tetap sama
    // ... (fungsi showScreen, openZone, renderQuestion, answer, dll tetap) ...

    // ---------- Mini games (PERBAIKAN untuk crossword) ----------
    document.querySelectorAll('.mini').forEach(b => b.addEventListener('click', e => {
      const m = e.target.dataset.min;
      startMini(m);
      showScreen('minigames');
    }));

    // Clear all game intervals
    function clearAllGameIntervals() {
      gameIntervals.forEach(interval => clearInterval(interval));
      gameIntervals = [];
    }
    
    function startMini(name) {
      const area = document.getElementById('miniArea');
      area.innerHTML = '';
      
      // Clear any existing game intervals
      clearAllGameIntervals();
      
      if (name === 'crossword') {
        area.innerHTML = `
          <p><strong>Teka-Teki Silang Biologi:</strong> Isi kotak dengan jawaban yang benar!</p>
          <div class="crossword-container">
            <div class="crossword-grid" id="crosswordGrid"></div>
            <div class="crossword-clues">
              <div class="clue-section">
                <h3>Mendatar</h3>
                <div class="clue-list" id="acrossClues"></div>
              </div>
              <div class="clue-section">
                <h3>Menurun</h3>
                <div class="clue-list" id="downClues"></div>
              </div>
            </div>
            <div class="crossword-controls">
              <button id="checkCrossword">Periksa Jawaban</button>
              <button id="hintCrossword">Bantuan</button>
              <button id="resetCrossword">Reset</button>
            </div>
            <div class="crossword-message" id="crosswordMessage"></div>
          </div>
          <button id="endMini">Selesai</button>
        `;
        
        // Crossword puzzle data - DIKOREKSI
        const crosswordData = {
          grid: [
            [1, 0, 0, 0, 0, 2, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [3, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [4, 0, 0, 0, 0, 5, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
          ],
          across: {
            1: { clue: "Organel penghasil energi sel", answer: "MITOKONDRIA", row: 0, col: 0, length: 10 },
            3: { clue: "Pigmen hijau pada tumbuhan", answer: "KLOROFIL", row: 3, col: 0, length: 8 },
            4: { clue: "Unit hereditas terkecil", answer: "GEN", row: 5, col: 0, length: 3 },
            5: { clue: "Proses pembuatan makanan tumbuhan", answer: "FOTOSINTESIS", row: 5, col: 5, length: 11 }
          },
          down: {
            1: { clue: "Pembawa informasi genetik", answer: "DNA", row: 0, col: 0, length: 3 },
            2: { clue: "Organel sintesis protein", answer: "RIBOSOM", row: 0, col: 5, length: 6 },
            3: { clue: "Bagian sel yang menyimpan materi genetik", answer: "NUKLEUS", row: 3, col: 0, length: 7 }
          }
        };
        
        // Generate solutions from answers - DIKOREKSI
        const solutions = {};
        
        // Process across clues
        Object.values(crosswordData.across).forEach(clue => {
          for (let i = 0; i < clue.length; i++) {
            const key = `${clue.row}-${clue.col + i}`;
            solutions[key] = clue.answer[i];
          }
        });
        
        // Process down clues
        Object.values(crosswordData.down).forEach(clue => {
          for (let i = 0; i < clue.length; i++) {
            const key = `${clue.row + i}-${clue.col}`;
            solutions[key] = clue.answer[i];
          }
        });
        
        // Create crossword grid
        const grid = document.getElementById('crosswordGrid');
        const acrossClues = document.getElementById('acrossClues');
        const downClues = document.getElementById('downClues');
        
        // Create grid cells - DIKOREKSI untuk memastikan semua sel yang seharusnya terisi ada input
        for (let row = 0; row < 10; row++) {
          for (let col = 0; col < 10; col++) {
            const cell = document.createElement('div');
            cell.className = 'crossword-cell';
            cell.dataset.row = row;
            cell.dataset.col = col;
            
            if (crosswordData.grid[row][col] === 0) {
              cell.classList.add('black');
            } else {
              if (crosswordData.grid[row][col] > 0) {
                cell.classList.add('numbered');
                cell.setAttribute('data-number', crosswordData.grid[row][col]);
              }
              
              // Only create input for cells that should have letters
              if (solutions[`${row}-${col}`]) {
                const input = document.createElement('input');
                input.type = 'text';
                input.maxLength = 1;
                input.dataset.row = row;
                input.dataset.col = col;
                
                // Auto-advance to next cell
                input.addEventListener('input', (e) => {
                  if (e.target.value && col < 9) {
                    const nextCell = document.querySelector(`input[data-row="${row}"][data-col="${col + 1}"]`);
                    if (nextCell && !nextCell.parentElement.classList.contains('black')) {
                      nextCell.focus();
                    }
                  }
                });
                
                // Handle arrow key navigation
                input.addEventListener('keydown', (e) => {
                  if (e.key === 'ArrowRight' && col < 9) {
                    const nextCell = document.querySelector(`input[data-row="${row}"][data-col="${col + 1}"]`);
                    if (nextCell) nextCell.focus();
                  } else if (e.key === 'ArrowLeft' && col > 0) {
                    const prevCell = document.querySelector(`input[data-row="${row}"][data-col="${col - 1}"]`);
                    if (prevCell) prevCell.focus();
                  } else if (e.key === 'ArrowDown' && row < 9) {
                    const nextCell = document.querySelector(`input[data-row="${row + 1}"][data-col="${col}"]`);
                    if (nextCell) nextCell.focus();
                  } else if (e.key === 'ArrowUp' && row > 0) {
                    const prevCell = document.querySelector(`input[data-row="${row - 1}"][data-col="${col}"]`);
                    if (prevCell) prevCell.focus();
                  }
                });
                
                cell.appendChild(input);
              }
            }
            
            grid.appendChild(cell);
          }
        }
        
        // Create clues
        Object.entries(crosswordData.across).forEach(([num, clueData]) => {
          const clueItem = document.createElement('div');
          clueItem.className = 'clue-item';
          clueItem.innerHTML = `<span class="clue-number">${num}</span>. ${clueData.clue} (${clueData.length} huruf)`;
          acrossClues.appendChild(clueItem);
        });
        
        Object.entries(crosswordData.down).forEach(([num, clueData]) => {
          const clueItem = document.createElement('div');
          clueItem.className = 'clue-item';
          clueItem.innerHTML = `<span class="clue-number">${num}</span>. ${clueData.clue} (${clueData.length} huruf)`;
          downClues.appendChild(clueItem);
        });
        
        // Check answers - DIKOREKSI untuk validasi yang lebih baik
        document.getElementById('checkCrossword').addEventListener('click', () => {
          let correct = true;
          let totalCells = 0;
          let correctCells = 0;
          const inputs = document.querySelectorAll('#crosswordGrid input');
          
          inputs.forEach(input => {
            const row = input.dataset.row;
            const col = input.dataset.col;
            const key = `${row}-${col}`;
            
            if (solutions[key]) {
              totalCells++;
              if (input.value.toUpperCase() === solutions[key]) {
                input.style.color = 'var(--accent)';
                input.style.background = 'rgba(57,240,214,0.1)';
                correctCells++;
              } else {
                input.style.color = '#ff6b6b';
                input.style.background = 'rgba(255,107,107,0.1)';
                correct = false;
              }
            }
          });
          
          const message = document.getElementById('crosswordMessage');
          if (correct && totalCells > 0) {
            message.textContent = `Selamat! Semua jawaban benar! (${correctCells}/${totalCells})`;
            message.className = 'crossword-message correct';
            successSfx();
          } else {
            message.textContent = `Masih ada jawaban yang salah. ${correctCells}/${totalCells} jawaban benar.`;
            message.className = 'crossword-message wrong';
          }
        });
        
        // Hint system - DIKOREKSI
        document.getElementById('hintCrossword').addEventListener('click', () => {
          const emptyInputs = Array.from(document.querySelectorAll('#crosswordGrid input'))
            .filter(input => !input.value && solutions[`${input.dataset.row}-${input.dataset.col}`]);
          
          if (emptyInputs.length > 0) {
            const randomInput = emptyInputs[Math.floor(Math.random() * emptyInputs.length)];
            const row = randomInput.dataset.row;
            const col = randomInput.dataset.col;
            const solution = solutions[`${row}-${col}`];
            
            randomInput.value = solution;
            randomInput.style.color = 'var(--accent2)';
            randomInput.style.background = 'rgba(123,97,255,0.1)';
            
            // Auto-advance to next cell
            if (col < 9) {
              const nextCell = document.querySelector(`input[data-row="${row}"][data-col="${parseInt(col) + 1}"]`);
              if (nextCell && !nextCell.parentElement.classList.contains('black')) {
                nextCell.focus();
              }
            }
          } else {
            document.getElementById('crosswordMessage').textContent = 'Semua kotak sudah terisi!';
          }
        });
        
        // Reset crossword
        document.getElementById('resetCrossword').addEventListener('click', () => {
          const inputs = document.querySelectorAll('#crosswordGrid input');
          inputs.forEach(input => {
            input.value = '';
            input.style.color = 'var(--accent)';
            input.style.background = 'transparent';
          });
          document.getElementById('crosswordMessage').textContent = '';
        });
        
        document.getElementById('endMini').onclick = () => {
          // Calculate score based on correct answers
          const inputs = document.querySelectorAll('#crosswordGrid input');
          let correctCount = 0;
          let totalCount = 0;
          
          inputs.forEach(input => {
            const row = input.dataset.row;
            const col = input.dataset.col;
            const key = `${row}-${col}`;
            
            if (solutions[key]) {
              totalCount++;
              if (input.value.toUpperCase() === solutions[key]) {
                correctCount++;
              }
            }
          });
          
          const score = Math.floor((correctCount / totalCount) * 30);
          state.xp += score;
          state.coins += Math.floor(score / 2);
          updateHUD();
          alert(`Selesai teka-teki! Anda mendapatkan ${score} XP (${correctCount}/${totalCount} benar)`);
        };
      }
      
      // Mini games lainnya (shooter dan drag) tetap sama
      // ... (mini games lainnya tetap) ...
    }

    // ---------- Helpers ----------
    function shuffleArray(a) {
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    
    function humanize(k) {
      return {
        cell: 'Micro Cell World',
        system: 'Human System Lab',
        plant: 'Plant Planet',
        dna: 'DNA Galaxy',
        eco: 'Eco Forest Realm',
        evo: 'Evolution Time Rift'
      }[k] || k;
    }

    // ---------- Init ----------
    initAudio();
    updateHUD();
    renderLeader();
    updateProgress();

    // Resume audio context on first user interact (Chrome autoplay policy)
    document.addEventListener('click', () => {
      if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
      startBackgroundMusic();
    }, { once: true });
  </script>
</body>
</html>
